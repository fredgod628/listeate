<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listeate</title>
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/1950/1950715.png">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .app-header { background-color: #008080; color: white; padding: 15px; text-align: center; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-custom { width: 100%; margin-bottom: 10px; padding: 15px; font-size: 1.1rem; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card-custom { border: none; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .section-view { display: none; padding: 20px; }
        .active { display: block; }
        #reader { width: 100%; border-radius: 10px; overflow: hidden; }
        .student-item { border-left: 5px solid #ccc; }
        .attended { border-left: 5px solid #28a745; background-color: #e8f5e9; }
    </style>
</head>
<body>

    <div class="app-header">
        <h1><i class="fas fa-clipboard-list"></i> Listeate</h1>
        <p class="mb-0">Control de Asistencia QR</p>
    </div>

    <div id="home-view" class="section-view active">
        <div class="d-grid gap-2">
            <button onclick="showSection('import-view')" class="btn btn-primary btn-custom"><i class="fas fa-file-upload"></i> 1. Cargar Lista (.csv)</button>
            <button onclick="renderStudentList()" class="btn btn-info text-white btn-custom"><i class="fas fa-qrcode"></i> 2. Ver Lista y QRs</button>
            <button onclick="startScanner()" class="btn btn-warning text-white btn-custom"><i class="fas fa-camera"></i> 3. Escanear Asistencia</button>
            <button onclick="exportCSV()" class="btn btn-success btn-custom"><i class="fas fa-file-download"></i> 4. Exportar Reporte</button>
            <hr>
            <button onclick="resetData()" class="btn btn-outline-danger">Borrar Todo</button>
        </div>
    </div>

    <div id="import-view" class="section-view">
        <h3>Cargar Estudiantes</h3>
        <div class="card card-custom p-3">
            <p>Sube un archivo .csv con los nombres (una columna).</p>
            <input type="file" id="csvFile" accept=".csv" class="form-control mb-3">
            <button onclick="processCSV()" class="btn btn-primary w-100">Procesar Archivo</button>
        </div>
        <button onclick="showSection('home-view')" class="btn btn-secondary w-100 mt-3">Volver</button>
    </div>

    <div id="list-view" class="section-view">
        <h3>Lista de Estudiantes</h3>
        <div id="students-container"></div>
        <button onclick="showSection('home-view')" class="btn btn-secondary w-100 mt-3">Volver</button>
    </div>

    <div id="scan-view" class="section-view">
        <h3>Escanear Asistencia</h3>
        <div id="reader"></div>
        <div id="scan-result" class="alert alert-info mt-3" style="display:none;"></div>
        <button onclick="stopScanner()" class="btn btn-secondary w-100 mt-3">Volver</button>
    </div>

    <div class="modal fade" id="qrModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Código QR</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <div id="modal-qr-target" style="display:inline-block;"></div>
                    <h4 id="modal-name" class="mt-2"></h4>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- LÓGICA DE LA APP ---
        
        let students = JSON.parse(localStorage.getItem('listeate_db')) || [];
        let html5QrcodeScanner = null;

        function saveData() {
            localStorage.setItem('listeate_db', JSON.stringify(students));
        }

        function showSection(id) {
            document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'list-view') renderStudentList();
        }

        // 1. IMPORTAR CSV
        function processCSV() {
            const fileInput = document.getElementById('csvFile');
            if (!fileInput.files.length) return alert("Selecciona un archivo");
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const text = e.target.result;
                const rows = text.split('\n');
                let count = 0;
                
                rows.forEach(row => {
                    const name = row.trim();
                    if (name) {
                        // Generamos un ID único basado en timestamp + random
                        const id = Date.now().toString(36) + Math.random().toString(36).substr(2);
                        students.push({ id: id, name: name, attended: false });
                        count++;
                    }
                });
                saveData();
                alert(`Se importaron ${count} estudiantes.`);
                showSection('home-view');
            };
            reader.readAsText(file);
        }

        // 2. GENERAR LISTA Y QRS
        function renderStudentList() {
            const container = document.getElementById('students-container');
            container.innerHTML = '';
            
            if(students.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">No hay estudiantes.</p>';
                return;
            }

            students.forEach((s, index) => {
                const div = document.createElement('div');
                div.className = `card card-custom p-3 student-item ${s.attended ? 'attended' : ''}`;
                div.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0">${s.name}</h5>
                            <small class="text-muted">${s.attended ? 'PRESENTE' : 'Ausente'}</small>
                        </div>
                        <button class="btn btn-outline-dark btn-sm" onclick="showQR('${s.id}', '${s.name}')"><i class="fas fa-eye"></i> QR</button>
                    </div>
                `;
                container.appendChild(div);
            });
            showSection('list-view');
        }

        function showQR(id, name) {
            const modal = new bootstrap.Modal(document.getElementById('qrModal'));
            document.getElementById('modal-qr-target').innerHTML = "";
            document.getElementById('modal-name').innerText = name;
            
            new QRCode(document.getElementById('modal-qr-target'), {
                text: id,
                width: 200,
                height: 200
            });
            modal.show();
        }

        // 3. ESCÁNER
        function startScanner() {
            showSection('scan-view');
            const resultDiv = document.getElementById('scan-result');
            resultDiv.style.display = 'none';

            html5QrcodeScanner = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess);
        }

        function onScanSuccess(decodedText, decodedResult) {
            // Reproducir sonido beep (opcional)
            // Buscar estudiante
            const index = students.findIndex(s => s.id === decodedText);
            const resultDiv = document.getElementById('scan-result');
            
            if (index !== -1) {
                if (!students[index].attended) {
                    students[index].attended = true;
                    saveData();
                    resultDiv.className = "alert alert-success mt-3";
                    resultDiv.innerText = `¡ÉXITO! Asistencia marcada para: ${students[index].name}`;
                } else {
                    resultDiv.className = "alert alert-warning mt-3";
                    resultDiv.innerText = `El estudiante ${students[index].name} YA estaba presente.`;
                }
            } else {
                resultDiv.className = "alert alert-danger mt-3";
                resultDiv.innerText = "Código QR no reconocido en la base de datos.";
            }
            resultDiv.style.display = 'block';
            
            // Pausar brevemente para leer el mensaje
            setTimeout(() => { resultDiv.style.display = 'none'; }, 3000);
        }

        function stopScanner() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    html5QrcodeScanner.clear();
                    showSection('home-view');
                }).catch(err => {
                    console.log(err);
                    showSection('home-view');
                });
            } else {
                showSection('home-view');
            }
        }

        // 4. EXPORTAR
        function exportCSV() {
            const attended = students.filter(s => s.attended);
            if (attended.length === 0) return alert("Nadie ha asistido aún.");

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "ID Interno,Nombre,Estado\n";
            
            attended.forEach(s => {
                csvContent += `${s.id},${s.name},PRESENTE\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "asistencia_listeate.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function resetData() {
            if(confirm("¿Estás seguro de borrar toda la lista?")) {
                students = [];
                saveData();
                alert("Datos borrados");
                renderStudentList(); // Refresh visual
            }
        }
    </script>
</body>
</html>